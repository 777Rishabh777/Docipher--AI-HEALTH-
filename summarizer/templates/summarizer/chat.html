{% extends 'base.html' %}

{% block title %}AI Assistant{% endblock %}

{% block content %}
<style>
    .chat-container {
        max-width: 900px;
        margin: 0 auto;
        background: #fff;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        border-radius: 24px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 80vh;
        border: 1px solid rgba(255,255,255,0.8);
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
        position: relative;
    }
    .chat-container::before {
        content: 'ðŸ¤–ðŸ’¬';
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 1.5rem;
        opacity: 0.2;
        animation: pulse 3s ease-in-out infinite;
    }
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    .chat-header {
        background: linear-gradient(135deg, #1976d2 0%, #7b1fa2 50%, #388e3c 100%);
        color: white;
        padding: 1.5rem 2rem;
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    .chat-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="60" cy="80" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="60" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="90" cy="20" r="1" fill="rgba(255,255,255,0.1)"/></svg>');
        animation: float 4s ease-in-out infinite;
    }
    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-5px); }
    }
    .chat-header .container {
        position: relative;
        z-index: 2;
    }
    .chat-header h3 {
        animation: fadeInUp 1s ease-out;
    }
    .chat-header p {
        animation: fadeInUp 1s ease-out 0.3s both;
    }
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    .chat-box {
        flex-grow: 1;
        padding: 2rem;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        position: relative;
    }
    .chat-box::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="10" cy="10" r="0.5" fill="rgba(25, 118, 210, 0.03)"/><circle cx="90" cy="20" r="0.8" fill="rgba(25, 118, 210, 0.03)"/><circle cx="70" cy="90" r="0.5" fill="rgba(25, 118, 210, 0.03)"/><circle cx="30" cy="70" r="0.8" fill="rgba(25, 118, 210, 0.03)"/><circle cx="50" cy="50" r="0.5" fill="rgba(25, 118, 210, 0.03)"/></svg>');
        pointer-events: none;
    }
    .message {
        max-width: 85%;
        padding: 1rem 1.5rem;
        border-radius: 20px;
        line-height: 1.6;
        margin-bottom: 1.5rem;
        position: relative;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .message:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    }
    .user-message {
        background: linear-gradient(135deg, #1976d2 0%, #7b1fa2 100%);
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 5px;
        position: relative;
    }
    .user-message::before {
        content: 'ðŸ‘¤';
        position: absolute;
        top: -10px;
        right: 10px;
        font-size: 1.2rem;
        opacity: 0.7;
    }
    .ai-message {
        background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        color: #333;
        align-self: flex-start;
        border-bottom-left-radius: 5px;
        border: 1px solid rgba(0,0,0,0.05);
        position: relative;
    }
    .ai-message::before {
        content: 'ðŸ¤–';
        position: absolute;
        top: -10px;
        left: 10px;
        font-size: 1.2rem;
        opacity: 0.7;
    }
    .chat-input-area {
        display: flex;
        padding: 2rem;
        border-top: 1px solid rgba(0,0,0,0.1);
        background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
        position: relative;
    }
    .chat-input-area::before {
        content: 'ðŸ’­';
        position: absolute;
        top: 15px;
        left: 20px;
        font-size: 1.2rem;
        opacity: 0.3;
        pointer-events: none;
    }
    #chat-input {
        border-radius: 25px;
        border: 2px solid #dee2e6;
        padding: 0.75rem 1rem 0.75rem 3rem;
        transition: all 0.3s ease;
        flex-grow: 1;
        margin-right: 1rem;
    }
    #chat-input:focus {
        border-color: #1976d2;
        box-shadow: 0 0 0 0.2rem rgba(25, 118, 210, 0.25);
        outline: none;
    }
    #send-btn {
        background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 50%, #45b7d1 100%);
        border: none;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 16px rgba(255, 107, 107, 0.3);
    }
    #send-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        background: linear-gradient(135deg, #4ecdc4 0%, #45b7d1 50%, #ff6b6b 100%);
    }
    #send-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }
    @media (max-width: 768px) {
        .chat-container {
            height: 85vh;
            margin: 0 1rem;
        }
        .chat-header {
            padding: 1rem;
        }
        .chat-box {
            padding: 1rem;
        }
        .chat-input-area {
            padding: 1rem;
        }
        .message {
            max-width: 95%;
        }
    }
</style>

<div class="container py-5">
    <div class="chat-container" data-aos="fade-up">
        <div class="chat-header">
            <h3 class="mb-0">AI Medical Assistant</h3>
            <p class="mb-0 small">Ask me any general health questions</p>
        </div>
        <div class="chat-box" id="chatbox">
            <div class="message ai-message">
                <strong>Disclaimer: I am an AI assistant and not a real doctor. Please consult a healthcare professional for any medical advice.</strong>
                <br><br>
                How can I help you today?
            </div>
        </div>
        <form class="chat-input-area" id="chat-form">
            {% csrf_token %}
            <input type="text" id="chat-input" class="form-control" placeholder="Type your message..." autocomplete="off" required>
            <button type="submit" class="btn btn-primary ms-2" id="send-btn" aria-label="Send message">
                <i class="bi bi-send-fill"></i>
            </button>
        </form>
    </div>
</div>

<script>
    const chatbox = document.getElementById('chatbox');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // Function to add a message to the chatbox
    function appendMessage(text, className) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', className);
        messageDiv.innerHTML = text.replace(/\n/g, '<br>'); // Replace newlines with <br>
        chatbox.appendChild(messageDiv);
        chatbox.scrollTop = chatbox.scrollHeight; // Auto-scroll to bottom
    }

    // Handle form submission
    chatForm.addEventListener('submit', function (event) {
        event.preventDefault(); // Stop page reload
        const userMessage = chatInput.value.trim();
        if (userMessage === '') return;

        // 1. Display user's message
        appendMessage(userMessage, 'user-message');
        chatInput.value = ''; // Clear input
        sendBtn.disabled = true; // Disable button

        // 2. Add a loading "..." message
        const loadingMessage = document.createElement('div');
        loadingMessage.classList.add('message', 'ai-message');
        loadingMessage.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
        chatbox.appendChild(loadingMessage);
        chatbox.scrollTop = chatbox.scrollHeight;

        // 3. Send message to Django backend
        fetch("{% url 'chatbot' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ message: userMessage })
        })
        .then(response => response.json())
        .then(data => {
            // 4. Remove loading message and display AI response
            chatbox.removeChild(loadingMessage);
            if (data.response) {
                appendMessage(data.response, 'ai-message');
            } else {
                appendMessage("Error: " + data.error, 'ai-message');
            }
            sendBtn.disabled = false; // Re-enable button
        })
        .catch(error => {
            chatbox.removeChild(loadingMessage);
            appendMessage("Sorry, a connection error occurred. Please try again.", 'ai-message');
            sendBtn.disabled = false;
        });
    });
</script>
{% endblock %}